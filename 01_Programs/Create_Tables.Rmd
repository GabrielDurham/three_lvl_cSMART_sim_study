---
title: "Create Tables"
output:
  html_document:
    df_print: paged
---

This is code which takes fit output and creates tables

```{r Load in Preamble}
# Load in packages and file paths
source(file="Preamble.R")
```

```{r Load in Functions}
# Pull in functions for general data maintenance
source(file=paste0(helper_funcs_path, "General_Data_Maintenance.R"))
# Pull in functions for pre-response MC simulations
source(file=paste0(helper_funcs_path, "Pre_R_Cond_Param_Sim.R"))
# Pull in functions for collecting all simulation parameters
source(file=paste0(helper_funcs_path, "Derive_Sim_Parameters.R"))
# Pull in functions for data simulation
source(file=paste0(helper_funcs_path, "Simulate_SMART_Data.R"))
# Pull in functions for model fitting
source(file=paste0(helper_funcs_path, "Simulate_and_Fit_Data.R"))
# Pull in functions for inference
source(file=paste0(helper_funcs_path, "Conduct_Inference.R"))
# Pull in table creation functions
source(file=paste0(helper_funcs_path, "Create_Tables.R"))
# Pull in model fitting function
source(file=paste0(model_fit_func_path, "function_v3.5_1.R"))
```

# Data Read In And Setup

```{r Initialize Filter Variables}
comp_filter <- "dtr_1==\"d_1_1\" & dtr_2==\"d_m1_m1\""
```

```{r Read in Inference Results}
base_run <- "run_20250308"
base_inference_output <- readRDS(file=paste0(analysis_path, base_run))



#es_run_hc <- "run_20250723"
es_run_hc <- "run_20250804"
es_run_lc <- "run_20250226a"
es_inference_output <- c(readRDS(file=paste0(analysis_path, es_run_hc)),
                         readRDS(file=paste0(analysis_path, es_run_lc)))



# Sample sizes 20, 30, 40, and 50
wv_misspec_run_un_1 <- c("run_20250302a")
# Sample sizes 75, 100, 150
wv_misspec_run_un_2 <- c("run_20250303")
# Sample sizes 20, 30, 40, 50, and 75
wv_misspec_run_in_1 <- c("run_20250306a")
# Sample sizes 100, 150
wv_misspec_run_in_2 <- c("run_20250307")
wvm_inference_output_raw <- 
  c(readRDS(file=paste0(analysis_path, wv_misspec_run_un_1)),
    readRDS(file=paste0(analysis_path, wv_misspec_run_un_2)),
    readRDS(file=paste0(analysis_path, wv_misspec_run_in_1)),
    readRDS(file=paste0(analysis_path, wv_misspec_run_in_2)))
```




```{r ID Problem Runs}

# Identify Problematic Runs
## There are some runs with variances sufficiently close to singularity that
## they skew results - it's *very* few (on the order of 0.01% of runs), but
## the resulting standard errors are so large they skew the overall results
sample_sizes_wvm <- c(20,30,40,50,75,100,150)
SE_threshold <- 100000
prob_iters <- list(NULL, NULL)
setting_bases <- c("sim_ASIC-WVM-ytot-thet-dAR-odUn-n:",
                   "sim_ASIC-WVM-ytot-thom-dIn-odIn-n:")
for (i in c(1,2)) {
  setting_base <- setting_bases[i]
  for (n in sample_sizes_wvm) {
    setting <- paste0(setting_base, n)
    n_lab <- paste0("N=", n)
    prob_its <- c()
    for (fit in names(wvm_inference_output_raw[[setting]])) {
      temp_data <- wvm_inference_output_raw[[setting]][[fit]][["EOS"]]
      prob_rows <- temp_data[temp_data$Std.Err>SE_threshold, ]
      prob_its <- unique(c(prob_its, unique(prob_rows$iter)))
    }
    prob_iters[[i]][[n_lab]] <- prob_its
  }
}
wvm_inference_output <- wvm_inference_output_raw
for (i in c(1,2)) {
  setting_base <- setting_bases[i]
  for (n in sample_sizes_wvm) {
    setting <- paste0(setting_base, n)
    n_lab <- paste0("N=", n)
    prob_its <- prob_iters[[i]][[n_lab]]
    if (length(prob_its)>0) {
       for (fit in names(wvm_inference_output[[setting]])) {
        drop_row_EOS <- 
          wvm_inference_output[[setting]][[fit]][["EOS"]]$iter %in% prob_its
        drop_row_AUC <- 
          wvm_inference_output[[setting]][[fit]][["AUC"]]$iter %in% prob_its
        wvm_inference_output[[setting]][[fit]][["EOS"]] <- 
          wvm_inference_output[[setting]][[fit]][["EOS"]][!(drop_row_EOS), ]
        wvm_inference_output[[setting]][[fit]][["AUC"]] <- 
          wvm_inference_output[[setting]][[fit]][["AUC"]][!(drop_row_AUC), ]
      } 
    }
  }
}
```






# Base Table For Estimator Validity

```{r Create Base Table}
base_table_fits <- list(
  "N=20"=list(fit_data=base_inference_output[["sim_ASIC-Primary-20"]][["fit_1"]][["EOS"]],
              filter_statement=comp_filter),
  "N=30"=list(fit_data=base_inference_output[["sim_ASIC-Primary-30"]][["fit_1"]][["EOS"]],
              filter_statement=comp_filter),
  "N=40"=list(fit_data=base_inference_output[["sim_ASIC-Primary-40"]][["fit_1"]][["EOS"]],
              filter_statement=comp_filter),
  "N=50"=list(fit_data=base_inference_output[["sim_ASIC-Primary-50"]][["fit_1"]][["EOS"]],
              filter_statement=comp_filter),
  "N=75"=list(fit_data=base_inference_output[["sim_ASIC-Primary-75"]][["fit_1"]][["EOS"]],
              filter_statement=comp_filter),
  "N=100"=list(fit_data=base_inference_output[["sim_ASIC-Primary-100"]][["fit_1"]][["EOS"]],
              filter_statement=comp_filter),
  "N=500"=list(fit_data=base_inference_output[["sim_ASIC-Primary-500"]][["fit_1"]][["EOS"]],
              filter_statement=comp_filter)
)
n_digits_base <- 2

base_table <- Summarize_Multiple_Fits(fit_list=base_table_fits)
base_table <- Round_and_Format_DF(df=base_table, n_digits=n_digits_base)
if (n_digits_base==3) {base_table_CI <- base_table
} else {
  base_table_CI <- Summarize_Multiple_Fits(fit_list=base_table_fits, 
                                           n_digit_ci=n_digits_base)
}

cols_to_show_base <- c("Description", "Relative_Bias", "RMSE", "Coverage")
#base_table$Relative_Bias <- 
#  paste0(base_table$Relative_Bias, " ", base_table_CI$relative_bias_CI)
#base_table$RMSE <- 
#  paste0(base_table$RMSE, " ", base_table_CI$RMSE_CI)
#base_table$Coverage <- 
#  paste0(base_table$Coverage, " ", base_table_CI$coverage_CI)


print(xtable(x=base_table[, cols_to_show_base]), include.rownames=FALSE)

```

# Static vs Longitudinal Power Comparison Tables

## High Correlation Setting
```{r Create High Correlation Effect Size Tables}
n_list_es_hc <- c(661, 106, 42, 27)

es_table_fits <- list(
  "$\\delta=0.2$ ($n=661$)"=
    list(fit_data=es_inference_output[["sim_ASIC-Eff-Size-yTot-n:2-ES:0.2"]][["fit_1"]][["EOS"]],
         filter_statement=comp_filter),
  "$\\delta=0.5$ ($n=106$)"=
    list(fit_data=es_inference_output[["sim_ASIC-Eff-Size-yTot-n:2-ES:0.5"]][["fit_1"]][["EOS"]],
              filter_statement=comp_filter),
  "$\\delta=0.8$ ($n=42$)"=
    list(fit_data=es_inference_output[["sim_ASIC-Eff-Size-yTot-n:2-ES:0.8"]][["fit_1"]][["EOS"]],
              filter_statement=comp_filter),
  "$\\delta=1.0$ ($n=27$)"=
    list(fit_data=es_inference_output[["sim_ASIC-Eff-Size-yTot-n:2-ES:1.0"]][["fit_1"]][["EOS"]],
              filter_statement=comp_filter)
)
es_table_fits_static <- list(
  "$\\delta=0.2$ ($n=661$)"=
    list(fit_data=es_inference_output[["sim_ASIC-Eff-Size-yTot-n:2-ES:0.2"]][["alt_fit_1"]],
         filter_statement=comp_filter),
  "$\\delta=0.5$ ($n=106$)"=
    list(fit_data=es_inference_output[["sim_ASIC-Eff-Size-yTot-n:2-ES:0.5"]][["alt_fit_1"]],
         filter_statement=comp_filter),
  "$\\delta=0.8$ ($n=42$)"=
    list(fit_data=es_inference_output[["sim_ASIC-Eff-Size-yTot-n:2-ES:0.8"]][["alt_fit_1"]],
         filter_statement=comp_filter),
  "$\\delta=1.0$ ($n=27$)"=
    list(fit_data=es_inference_output[["sim_ASIC-Eff-Size-yTot-n:2-ES:1.0"]][["alt_fit_1"]],
         filter_statement=comp_filter)
)
es_table_1 <- Summarize_Multiple_Fits(fit_list=es_table_fits)
es_table_1 <- Round_and_Format_DF(df=es_table_1, n_digits=2)

es_table_2 <- Summarize_Multiple_Fits(fit_list=es_table_fits_static)
es_table_2 <- Round_and_Format_DF(df=es_table_2, n_digits=2)

es_table_hc <- data.frame()
#cols_to_show_es_hc <- c("Relative_Bias", "RMSE", "Coverage", "Power")
cols_to_show_es_hc <- c("RMSE", "Coverage", "Power")

for (es in unique(es_table_1$Description)) {
  new_row <- data.frame("Effect Size (n)"=es)
  long_data <- es_table_1[es_table_1$Description==es, ]
  static_data <- es_table_2[es_table_2$Description==es, ]
  for (col in cols_to_show_es_hc) {
    new_row[[paste0(col,"_static")]] <- static_data[[col]]
    new_row[[paste0(col,"_long")]] <- long_data[[col]]
  }
  es_table_hc <- rbind(es_table_hc, new_row)
}


es_table_hc_cap <- 
  Create_Caption(table=es_table_hc,
                 caption="Static vs Longitudinal Power Comparison - High Correlation",
                 label="tab:Power_Comp")


print(xtable(x=es_table_hc), include.rownames=FALSE, 
      add.to.row=es_table_hc_cap, sanitize.text.function=function(x){x})
```




## Medium Correlation Setting

```{r Create Low Correlation Effect Size Tables}
n_list_es_lc <- c(633, 102, 40, 26)


es_lc_table_fits <- list(
  "$\\delta=0.2$ ($n=633$)"=
    list(fit_data=es_inference_output[["sim_ASIC-Eff-Size-y-n:2-ES:0.2"]][["fit_1"]][["EOS"]],
         filter_statement=comp_filter),
  "$\\delta=0.5$ ($n=102$)"=
    list(fit_data=es_inference_output[["sim_ASIC-Eff-Size-y-n:2-ES:0.5"]][["fit_1"]][["EOS"]],
              filter_statement=comp_filter),
  "$\\delta=0.8$ ($n=40$)"=
    list(fit_data=es_inference_output[["sim_ASIC-Eff-Size-y-n:2-ES:0.8"]][["fit_1"]][["EOS"]],
              filter_statement=comp_filter),
  "$\\delta=1.0$ ($n=26$)"=
    list(fit_data=es_inference_output[["sim_ASIC-Eff-Size-y-n:2-ES:1.0"]][["fit_1"]][["EOS"]],
              filter_statement=comp_filter)
)
es_lc_table_fits_static <- list(
  "$\\delta=0.2$ ($n=633$)"=
    list(fit_data=es_inference_output[["sim_ASIC-Eff-Size-y-n:2-ES:0.2"]][["alt_fit_1"]],
         filter_statement=comp_filter),
  "$\\delta=0.5$ ($n=102$)"=
    list(fit_data=es_inference_output[["sim_ASIC-Eff-Size-y-n:2-ES:0.5"]][["alt_fit_1"]],
         filter_statement=comp_filter),
  "$\\delta=0.8$ ($n=40$)"=
    list(fit_data=es_inference_output[["sim_ASIC-Eff-Size-y-n:2-ES:0.8"]][["alt_fit_1"]],
         filter_statement=comp_filter),
  "$\\delta=1.0$ ($n=26$)"=
    list(fit_data=es_inference_output[["sim_ASIC-Eff-Size-y-n:2-ES:1.0"]][["alt_fit_1"]],
         filter_statement=comp_filter)
)
es_lc_table_1 <- Summarize_Multiple_Fits(fit_list=es_lc_table_fits)
es_lc_table_1 <- Round_and_Format_DF(df=es_lc_table_1, n_digits=2)

es_lc_table_2 <- Summarize_Multiple_Fits(fit_list=es_lc_table_fits_static)
es_lc_table_2 <- Round_and_Format_DF(df=es_lc_table_2, n_digits=2)

es_table_lc <- data.frame()
#cols_to_show_es_lc <- c("Relative_Bias", "RMSE", "Coverage", "Power")
cols_to_show_es_lc <- c("RMSE", "Coverage", "Power")
for (es in unique(es_lc_table_1$Description)) {
  new_row <- data.frame("Effect Size (n)"=es)
  long_data <- es_lc_table_1[es_lc_table_1$Description==es, ]
  static_data <- es_lc_table_2[es_lc_table_2$Description==es, ]
  for (col in cols_to_show_es_lc) {
    new_row[[paste0(col,"_static")]] <- static_data[[col]]
    new_row[[paste0(col,"_long")]] <- long_data[[col]]
  }
  es_table_lc <- rbind(es_table_lc, new_row)
}


es_table_lc_cap <- 
  Create_Caption(table=es_table_lc,
                 caption="Static vs Longitudinal Power Comparison - Low Correlation",
                 label="tab:Power_Comp_LC")


print(xtable(x=es_table_lc), include.rownames=FALSE, 
      add.to.row=es_table_lc_cap, sanitize.text.function=function(x){x})
```





# Working Variance Misspecification Tables and Graphs


```{r Process Working Variance Misspecification Tables}
wvm_table_fits <- list(Un=NULL, In=NULL)
wvm_tables <- list(Un=NULL, In=NULL)
for (dg_setting in names(wvm_table_fits)) {
  wvm_table_fits[[dg_setting]] <- list(t_hom=NULL, t_het=NULL)
  wvm_tables[[dg_setting]] <- list(t_hom=NULL, t_het=NULL)
  for (t_pool in names(wvm_table_fits[[dg_setting]])) {
    # Only ran some independent fits
    if (dg_setting=="Un") {
      wvm_table_fits[[dg_setting]][[t_pool]] <- 
        list(ind=NULL, d_ind_od_un=NULL, d_AR_od_ind=NULL, d_AR_od_un=NULL)
      wvm_tables[[dg_setting]][[t_pool]] <- 
        list(ind=NULL, d_ind_od_un=NULL, d_AR_od_ind=NULL, d_AR_od_un=NULL)
    } else {
      wvm_table_fits[[dg_setting]][[t_pool]] <- 
        list(ind=NULL, d_AR_od_un=NULL)
      wvm_tables[[dg_setting]][[t_pool]] <- 
        list(ind=NULL, d_AR_od_un=NULL)
    }
    
}}
sample_sizes_wvm <- c(20,30,40,50,75,100,150)


for (dg_setting in names(wvm_table_fits)) {for (t_pool in names(wvm_table_fits[[dg_setting]])) {
    sim_label_base <- ifelse(dg_setting=="Un", "sim_ASIC-WVM-ytot-thet-dAR-odUn",
                             "sim_ASIC-WVM-ytot-thom-dIn-odIn")
    for (fit in names(wvm_table_fits[[dg_setting]][[t_pool]])) {
      fit_base <- ifelse(t_pool=="t_hom", 1, 5)
      fit_sub_num <- ifelse(fit=="ind", 0,
                            ifelse(fit=="d_ind_od_un", 1,
                            ifelse(fit=="d_AR_od_ind", 2,
                            ifelse(fit=="d_AR_od_un", 3, NA))))
      fit_label <- paste0("fit_", fit_base+fit_sub_num)
      # Only ran some independent fits
      fit_label <- ifelse(dg_setting=="Un", fit_label,
                      ifelse(fit_label=="fit_1", "fit_1",
                      ifelse(fit_label=="fit_4", "fit_2",
                      ifelse(fit_label=="fit_5", "fit_3",
                      ifelse(fit_label=="fit_8", "fit_4", NA)))))
      if (!is.na(fit_label)) {
        for (n in sample_sizes_wvm) {
          sim_label <- paste0(sim_label_base, "-n:", n)
          wvm_table_fits[[dg_setting]][[t_pool]][[fit]][[paste0("N=",n)]] <- 
            list(fit_data=wvm_inference_output[[sim_label]][[fit_label]][["EOS"]],
                 filter_statement=comp_filter)
        }
        temp_table <- Summarize_Multiple_Fits(fit_list=wvm_table_fits[[dg_setting]][[t_pool]][[fit]])
        temp_table$SE_Ratio_IID <- 0
        for (n in sample_sizes_wvm) {
          temp_table[temp_table$Description==paste0("N=",n), "SE_Ratio_IID"] <- 
            Compare_Across_Iterations(wvm_table_fits[[dg_setting]][["t_hom"]][["ind"]][[paste0("N=",n)]],
                                      wvm_table_fits[[dg_setting]][[t_pool]][[fit]][[paste0("N=",n)]])
        }
        wvm_tables[[dg_setting]][[t_pool]][[fit]] <- temp_table
      }
}}}

      
```

## Plots with Color

```{r Get Info For WVM Graphs}
wvm_graph_data_shell <- data.frame(SE_Ratio_IID=numeric(),
                                   Coverage=numeric(),
                                   RMSE=numeric(),
                                   N=numeric(),
                                   t_pool=character(),
                                   corr=character(),
                                   n_parms=numeric())
wvm_graph_data <- NULL
include_mean_parms <- FALSE
mean_parm_inclusion <- ifelse(include_mean_parms, 9, 0)
for (dg_setting in names(wvm_table_fits)) {
  wvm_graph_data[[dg_setting]] <- wvm_graph_data_shell
  for (t_pool in names(wvm_table_fits[[dg_setting]])) {
    for (fit in names(wvm_table_fits[[dg_setting]][[t_pool]])) {
      t_pool_lab <- ifelse(t_pool=="t_hom", "Pool Across t",
                           "Vary Across t")
      corr_lab <- 
        ifelse(fit=="ind", "Independent",
        ifelse(fit=="d_ind_od_un", "Independent Within Person, Unstructured Between Person",
        ifelse(fit=="d_AR_od_ind", "AR(1) Within Person, Independent Between Person",
        "AR(1) Within Person, Unstructured Between Person")))
      temp_table <- wvm_tables[[dg_setting]][[t_pool]][[fit]]
      
      n_parms_var <- ifelse(t_pool=="t_hom", 1, 3)
      n_parms_corr_wp <- ifelse(fit %in% c("d_AR_od_ind", "d_AR_od_un"), 1, 0)
      n_parms_corr_bp <- ifelse(fit %in% c("d_ind_od_un", "d_AR_od_un"), 6, 0)
      n_parms <- n_parms_var + n_parms_corr_wp + n_parms_corr_bp + mean_parm_inclusion
      for (n in sample_sizes_wvm) {
        rel_row <- temp_table[temp_table$Description==paste0("N=", n), ]
        new_row <- 
          data.frame(SE_Ratio_IID=rel_row$SE_Ratio_IID,
                     Coverage=rel_row$Coverage,
                     RMSE=rel_row$RMSE,
                     N=n,
                     t_pool=t_pool_lab,
                     corr=corr_lab,
                     n_parms=n_parms,
                     n_parms_pct=n_parms/n,
                     parms_n_pct=n/n_parms)
        wvm_graph_data[[dg_setting]] <- 
          rbind(wvm_graph_data[[dg_setting]], new_row)
}}}}

wvm_graph_data[["Un"]]$corr.f <- factor(wvm_graph_data[["Un"]]$corr, levels = c(
  "Independent",
  "Independent Within Person, Unstructured Between Person",
  "AR(1) Within Person, Independent Between Person",
  "AR(1) Within Person, Unstructured Between Person"
))

wvm_graph_data[["In"]]$corr.f <- factor(wvm_graph_data[["In"]]$corr, levels = c(
  "Independent",
  "AR(1) Within Person, Unstructured Between Person"
))

```

```{r WVM Plot Specs}
Create_WVM_Plot <- function(graph_data, y_var, y_axis_label, legend.position="none") {
  # Plot
  ggplot(graph_data, 
         aes(x = N, y = .data[[y_var]], 
             color = corr.f, linetype = t_pool, 
             group = interaction(t_pool, corr))) +
    geom_line(linewidth = 1) +
    theme_minimal() +
    labs(x = "Number of Clusters (N)",
         y = y_axis_label, 
         color = "Correlation Structure", 
         linetype = "Variance Across Time") +
    theme(legend.position = legend.position, text=element_text(family = "Times", size=16))  # Hide legend in individual plots
    # theme(legend.position = "right")
}

```

```{r Make Unstructured WVP Plots}

wvm_plot_se <- Create_WVM_Plot(wvm_graph_data[["Un"]], "SE_Ratio_IID", 
                               expression(sqrt("Relative Efficiency"))) 
wvm_plot_cov <- Create_WVM_Plot(wvm_graph_data[["Un"]], "Coverage", "Coverage",
                               legend.position="right") +
  coord_cartesian(ylim = c(0.90, 0.96)) +  # (1) Force y-axis range
  geom_hline(yintercept = 0.95, color = "black", linetype = "dotted", 
             linewidth = 1)  # (2) Horizontal line at 0.95
wvm_plot_parms <- Create_WVM_Plot(wvm_graph_data[["Un"]], 
                                  "n_parms_pct", 
                                  "Number of Variance Parameters/N")#, legend.position="right")
save_plots <- TRUE
if (save_plots) {
  ggsave(paste0(figures_path, "wvm_plot_se.png"), 
         plot = wvm_plot_se, width = 14, height = 4, dpi = 300, bg = "white")
  
  ggsave(paste0(figures_path, "wvm_plot_cov.png"), 
         plot = wvm_plot_cov, width = 14, height = 4, dpi = 300, bg = "white")
  
  ggsave(paste0(figures_path, "wvm_plot_parms.png"), 
         plot = wvm_plot_parms, width = 8, height = 4, dpi = 300, bg = "white")
}

```





```{r Make Independent WVM Plots}
wvm_plot_se_IN <- Create_WVM_Plot(wvm_graph_data[["In"]], "SE_Ratio_IID", 
                                  expression(sqrt("Relative Efficiency"))) +
  coord_cartesian(ylim = c(0.90, 1.05))  # (1) Force y-axis range to compare to unstructured case
wvm_plot_cov_IN <- Create_WVM_Plot(wvm_graph_data[["In"]], "Coverage", "Coverage",
                               legend.position="right") +
  coord_cartesian(ylim = c(0.90, 0.96)) +  # (1) Force y-axis range
  geom_hline(yintercept = 0.95, color = "black", linetype = "dotted", 
             linewidth = 1)  # (2) Horizontal line at 0.95
wvm_plot_parms_IN <- Create_WVM_Plot(wvm_graph_data[["In"]], 
                                  "n_parms_pct", 
                                  "Number of Variance Parameters/N")#, legend.position="right")
save_plots <- TRUE
if (save_plots) {
  ggsave(paste0(figures_path, "wvm_plot_se_IN.png"), 
         plot = wvm_plot_se_IN, width = 14, height = 4, dpi = 300, bg = "white")
  
  ggsave(paste0(figures_path, "wvm_plot_cov_IN.png"), 
         plot = wvm_plot_cov_IN, width = 14, height = 4, dpi = 300, bg = "white")
  
  ggsave(paste0(figures_path, "wvm_plot_parms_IN.png"), 
         plot = wvm_plot_parms_IN, width = 8, height = 4, dpi = 300, bg = "white")
}
```



## Tables

```{r WVM Tables}
wvm_un_table_cov <- data.frame()
wvm_un_table_se <- data.frame()

for (t_pool in names(wvm_tables[["Un"]])) {
  if (t_pool=="t_het") {new_row <- data.frame(Var_Time="Heterogeneous")
  } else {new_row <- data.frame(Var_Time="Homogeneous")}
  for (corr_str in names(wvm_tables[["Un"]][[t_pool]])) {
    if (corr_str=="ind") {
      new_row$Corr_WI <- "Independent"
      new_row$Corr_BT <- "Independent"
    } else if (corr_str=="d_AR_od_un") {
      new_row$Corr_WI <- "AR(1)"
      new_row$Corr_BT <- "Unstructured"
    } else if (corr_str=="d_AR_od_ind") {
      new_row$Corr_WI <- "AR(1)"
      new_row$Corr_BT <- "Independent"
    } else if (corr_str=="d_ind_od_un") {
      new_row$Corr_WI <- "Independent"
      new_row$Corr_BT <- "Unstructured"
    }
    sim_results <- wvm_tables[["Un"]][[t_pool]][[corr_str]]
    new_row_cov <- new_row
    new_row_se <- new_row
    for (description in unique(sim_results$Description)) {
      results_row <- sim_results[sim_results$Description==description, ]
      new_row_cov[[description]] <- results_row$Coverage
      new_row_se[[description]] <- results_row$SE_Ratio_IID
    }
    wvm_un_table_cov <- rbind(wvm_un_table_cov, new_row_cov)
    wvm_un_table_se <- rbind(wvm_un_table_se, new_row_se)
  }
}

wvm_un_table_cov <- Round_and_Format_DF(df=wvm_un_table_cov, n_digits=2)
wvm_un_table_se <- Round_and_Format_DF(df=wvm_un_table_se, n_digits=2)
```


## Reformatted Plots Without Color

```{r}
Create_WVM_Plot_One_Corr <- function(graph_data, y_var, y_axis_label, corr_str,
                                     legend.position="none") {
  # Plot
  temp_graph_data <- graph_data[graph_data$corr==corr_str, ]
  Output <- ggplot(temp_graph_data, 
                   aes(x = N, y = .data[[y_var]], linetype = t_pool, 
                       group = t_pool)) +
    geom_line(linewidth = 1) +
    theme_minimal() +
    labs(x = "Number of Clusters (N)",
         y = y_axis_label, 
         linetype = "Variance Across Time") +
    theme(legend.position = legend.position, 
          text=element_text(family = "Times", size=16))  # Hide legend in individual plots
    # theme(legend.position = "right")
  return(Output)
}
save_plots <- TRUE
se_bounds <- c(0.9, 1.05)
wvm_plots_bw <- NULL
for (corr in unique(wvm_graph_data[["Un"]]$corr)) {
  lab <- 
    ifelse(corr=="Independent", "Ind_Ind",
    ifelse(corr=="Independent Within Person, Unstructured Between Person", "Ind_Un",
    ifelse(corr=="AR(1) Within Person, Independent Between Person", "AR1_In", 
           "AR1_Un")))
  wvm_plots_bw[[lab]] <- 
    Create_WVM_Plot_One_Corr(wvm_graph_data[["Un"]], y_var="SE_Ratio_IID", 
                             y_axis_label=expression(sqrt("Relative Efficiency")), corr_str=corr) + 
    coord_cartesian(ylim=se_bounds) + 
    theme(axis.title.x=element_text(size=16),
          axis.title.y=element_text(size=16))
  if (save_plots) {
    file_name <- paste0("wvm_plot_se_bw_", lab, ".png")
      ggsave(paste0(figures_path, file_name), plot = wvm_plots_bw[[lab]], 
             width = 5, height = 3, dpi = 300, bg = "white")
  }
  
}

```


```{r Plot All In One}
joint_plot_df <- wvm_graph_data[["Un"]]
strs_modeling_wp <- 
  c("AR(1) Within Person, Independent Between Person",
    "AR(1) Within Person, Unstructured Between Person")
strs_modeling_bp <- 
  c("Independent Within Person, Unstructured Between Person",
    "AR(1) Within Person, Unstructured Between Person")
joint_plot_df$model_wp <- 
  factor(ifelse(joint_plot_df$corr %in% strs_modeling_wp, "Yes", "No"),
         levels = c("No", "Yes"))
joint_plot_df$model_bp <- 
  factor(ifelse(joint_plot_df$corr %in% strs_modeling_bp, "Yes", "No"),
         levels = c("No", "Yes"))
joint_plot_df$t_pool <- ifelse(joint_plot_df$t_pool=="Pool Across t",
                               "Constant Variance Across Time (Homoscedastic)",
                               "Separate Variances Across Time (Heteroscedastic)")
p <- ggplot(joint_plot_df, aes(x = N, y = SE_Ratio_IID, linetype = t_pool)) +
  geom_line(linewidth = 1) +
  facet_grid(model_bp ~ model_wp,
             labeller = labeller(
               model_wp = c("Yes" = "Yes", "No" = "No"),
               model_bp = c("Yes" = "Yes", "No" = "No")
             ),
             switch = "both") +
  labs(
    x = "Number of Clusters (N)",
    y = expression(sqrt("Relative Efficiency")),
    linetype = "Variance Temporal Model:",
  ) +
  theme_bw() +
  theme(
    text=element_text(family = "Times", size=12),
    strip.background = element_blank(),
    strip.placement = "outside",
    strip.text.x = element_text(face = "bold", size = 11),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.title = element_text(size = 16),
    strip.text.x.bottom = element_blank(),
    strip.text.y.left = element_blank(),
    legend.title = element_blank(),
    legend.text = element_text(family = "Times", size=10),
    legend.position = "bottom",
    legend.justification = "left",
    legend.box.just = "left",
    legend.spacing.y = unit(200, "pt"),
    legend.margin = margin(t = -5),  # try -5 or -10
    plot.margin = margin(b = 15, t = 5, r = 5, l = 5),
    legend.direction = "vertical",
    legend.key.height = unit(0.375, "lines")
) + 
  guides(linetype = guide_legend(ncol=1, byrow = TRUE, 
                                 label.vjust = 0.5, label.hjust = 0)) 

label_df <- data.frame(
  model_wp = factor(c("No", "Yes", "No", "Yes"), levels = c("No", "Yes")),
  model_bp = factor(c("No", "No", "Yes", "Yes"), levels = c("No", "Yes")),
  label = c("(a)", "(b)", "(c)", "(d)"),
  x = 135,       # max of your x-axis range
  y = 1.03      # top of your y-axis range
)


wvm_plot_un_bw <- p +
  geom_text(data = label_df, aes(x = x, y = y, label = label),
            inherit.aes = FALSE,
            family = "Times New Roman", fontface = "plain", size = 5)

save_plots <- TRUE
if (save_plots) {
    file_name <- "wvm_plot_un_bw.png"
    ggsave(paste0(figures_path, file_name), plot = wvm_plot_un_bw, 
           width = 5, height = 3, dpi = 300, bg = "white")
}
wvm_plot_un_bw
```




# Tables For More Than Three Time Points
## Seven Time Points

```{r Read in Multi T7 Output}
multi_t7_inference_output <- readRDS(file=paste0(analysis_path, "run_20250606"))
multi_t7_table_fits <- list(
  "N=20"= list(fit_data=multi_t7_inference_output[["sim_Alt-ASIC-Eff-Size-y-n:2-ES:0.2-N:20"]][["fit_1"]][["EOS"]],
               filter_statement=comp_filter),
  "N=30"= list(fit_data=multi_t7_inference_output[["sim_Alt-ASIC-Eff-Size-y-n:2-ES:0.2-N:30"]][["fit_1"]][["EOS"]],
               filter_statement=comp_filter),
  "N=40"= list(fit_data=multi_t7_inference_output[["sim_Alt-ASIC-Eff-Size-y-n:2-ES:0.2-N:40"]][["fit_1"]][["EOS"]],
               filter_statement=comp_filter),
  "N=50"= list(fit_data=multi_t7_inference_output[["sim_Alt-ASIC-Eff-Size-y-n:2-ES:0.2-N:50"]][["fit_1"]][["EOS"]],
               filter_statement=comp_filter),
  "N=75"= list(fit_data=multi_t7_inference_output[["sim_Alt-ASIC-Eff-Size-y-n:2-ES:0.2-N:75"]][["fit_1"]][["EOS"]],
               filter_statement=comp_filter),
  "N=100"= list(fit_data=multi_t7_inference_output[["sim_Alt-ASIC-Eff-Size-y-n:2-ES:0.2-N:100"]][["fit_1"]][["EOS"]],
               filter_statement=comp_filter)
)

multi_t7_table_fits_sat <- list(
  "N=20"= list(fit_data=multi_t7_inference_output[["sim_Alt-ASIC-Eff-Size-y-n:2-ES:0.2-N:20"]][["fit_2"]][["EOS"]],
               filter_statement=comp_filter),
  "N=30"= list(fit_data=multi_t7_inference_output[["sim_Alt-ASIC-Eff-Size-y-n:2-ES:0.2-N:30"]][["fit_2"]][["EOS"]],
               filter_statement=comp_filter),
  "N=40"= list(fit_data=multi_t7_inference_output[["sim_Alt-ASIC-Eff-Size-y-n:2-ES:0.2-N:40"]][["fit_2"]][["EOS"]],
               filter_statement=comp_filter),
  "N=50"= list(fit_data=multi_t7_inference_output[["sim_Alt-ASIC-Eff-Size-y-n:2-ES:0.2-N:50"]][["fit_2"]][["EOS"]],
               filter_statement=comp_filter),
  "N=75"= list(fit_data=multi_t7_inference_output[["sim_Alt-ASIC-Eff-Size-y-n:2-ES:0.2-N:75"]][["fit_2"]][["EOS"]],
               filter_statement=comp_filter),
  "N=100"= list(fit_data=multi_t7_inference_output[["sim_Alt-ASIC-Eff-Size-y-n:2-ES:0.2-N:100"]][["fit_2"]][["EOS"]],
               filter_statement=comp_filter)
)

```

```{r Make Multi t7 Tables}
multi_t7_table_all <- Summarize_Multiple_Fits(fit_list=multi_t7_table_fits)
multi_t7_table_all <- Round_and_Format_DF(df=multi_t7_table_all, n_digits=2)



multi_t7_table_sat <- Summarize_Multiple_Fits(fit_list=multi_t7_table_fits_sat)
multi_t7_table_sat <- Round_and_Format_DF(df=multi_t7_table_sat, n_digits=2)

multi_t7_table <- data.frame()
#cols_to_show_multi_t <- c("Description", "Relative_Bias", "SD", "RMSE", "Coverage", "CI_Width")
cols_to_show_multi_t <- c("Relative_Bias", "RMSE", "Coverage", "CI_Width")

for (n in unique(multi_t7_table_all$Description)) {
  new_row <- data.frame("Number of Clusters"=n)
  all_data <- multi_t7_table_all[multi_t7_table_all$Description==n, ]
  sat_data <- multi_t7_table_sat[multi_t7_table_sat$Description==n, ]
  for (col in cols_to_show_multi_t) {
    new_row[[paste0(col,"_sat")]] <- sat_data[[col]]
    new_row[[paste0(col,"_all")]] <- all_data[[col]]
  }
  multi_t7_table <- rbind(multi_t7_table, new_row)
}


multi_t7_table_cap <- 
  Create_Caption(table=multi_t7_table,
                 caption="Estimator Performance: Number of Time Points Modeled",
                 label="tab:multi_t7_Sim")


print(xtable(x=multi_t7_table), include.rownames=FALSE, 
      add.to.row=multi_t7_table_cap, sanitize.text.function=function(x){x})




```




## Five Time Points

```{r Read in Multi T5 Output}
multi_t5_inference_output <- readRDS(file=paste0(analysis_path, "run_20250612b"))
multi_t5_table_fits <- list(
  "N=20"= list(fit_data=multi_t5_inference_output[["sim_Alt-ASIC-Eff-Size-y-n:2-ES:0.2-N:20-t:5"]][["fit_1"]][["EOS"]],
               filter_statement=comp_filter),
  "N=30"= list(fit_data=multi_t5_inference_output[["sim_Alt-ASIC-Eff-Size-y-n:2-ES:0.2-N:30-t:5"]][["fit_1"]][["EOS"]],
               filter_statement=comp_filter),
  "N=40"= list(fit_data=multi_t5_inference_output[["sim_Alt-ASIC-Eff-Size-y-n:2-ES:0.2-N:40-t:5"]][["fit_1"]][["EOS"]],
               filter_statement=comp_filter),
  "N=50"= list(fit_data=multi_t5_inference_output[["sim_Alt-ASIC-Eff-Size-y-n:2-ES:0.2-N:50-t:5"]][["fit_1"]][["EOS"]],
               filter_statement=comp_filter),
  "N=75"= list(fit_data=multi_t5_inference_output[["sim_Alt-ASIC-Eff-Size-y-n:2-ES:0.2-N:75-t:5"]][["fit_1"]][["EOS"]],
               filter_statement=comp_filter),
  "N=100"= list(fit_data=multi_t5_inference_output[["sim_Alt-ASIC-Eff-Size-y-n:2-ES:0.2-N:100-t:5"]][["fit_1"]][["EOS"]],
               filter_statement=comp_filter)
)

multi_t5_table_fits_sat <- list(
  "N=20"= list(fit_data=multi_t5_inference_output[["sim_Alt-ASIC-Eff-Size-y-n:2-ES:0.2-N:20-t:5"]][["fit_2"]][["EOS"]],
               filter_statement=comp_filter),
  "N=30"= list(fit_data=multi_t5_inference_output[["sim_Alt-ASIC-Eff-Size-y-n:2-ES:0.2-N:30-t:5"]][["fit_2"]][["EOS"]],
               filter_statement=comp_filter),
  "N=40"= list(fit_data=multi_t5_inference_output[["sim_Alt-ASIC-Eff-Size-y-n:2-ES:0.2-N:40-t:5"]][["fit_2"]][["EOS"]],
               filter_statement=comp_filter),
  "N=50"= list(fit_data=multi_t5_inference_output[["sim_Alt-ASIC-Eff-Size-y-n:2-ES:0.2-N:50-t:5"]][["fit_2"]][["EOS"]],
               filter_statement=comp_filter),
  "N=75"= list(fit_data=multi_t5_inference_output[["sim_Alt-ASIC-Eff-Size-y-n:2-ES:0.2-N:75-t:5"]][["fit_2"]][["EOS"]],
               filter_statement=comp_filter),
  "N=100"= list(fit_data=multi_t5_inference_output[["sim_Alt-ASIC-Eff-Size-y-n:2-ES:0.2-N:100-t:5"]][["fit_2"]][["EOS"]],
               filter_statement=comp_filter)
)

```

```{r Make Multi t5 Tables}
multi_t5_table_all <- Summarize_Multiple_Fits(fit_list=multi_t5_table_fits)
multi_t5_table_all <- Round_and_Format_DF(df=multi_t5_table_all, n_digits=2)



multi_t5_table_sat <- Summarize_Multiple_Fits(fit_list=multi_t5_table_fits_sat)
multi_t5_table_sat <- Round_and_Format_DF(df=multi_t5_table_sat, n_digits=2)

multi_t5_table <- data.frame()
#cols_to_show_multi_t <- c("Description", "Relative_Bias", "SD", "RMSE", "Coverage", "CI_Width")
cols_to_show_multi_t <- c("Relative_Bias", "RMSE", "Coverage", "CI_Width")

for (n in unique(multi_t5_table_all$Description)) {
  new_row <- data.frame("Number of Clusters"=n)
  all_data <- multi_t5_table_all[multi_t5_table_all$Description==n, ]
  sat_data <- multi_t5_table_sat[multi_t5_table_sat$Description==n, ]
  for (col in cols_to_show_multi_t) {
    new_row[[paste0(col,"_sat")]] <- sat_data[[col]]
    new_row[[paste0(col,"_all")]] <- all_data[[col]]
  }
  multi_t5_table <- rbind(multi_t5_table, new_row)
}


multi_t5_table_cap <- 
  Create_Caption(table=multi_t5_table,
                 caption="Estimator Performance: Number of Time Points Modeled",
                 label="tab:multi_t5_Sim")


print(xtable(x=multi_t5_table), include.rownames=FALSE, 
      add.to.row=multi_t5_table_cap, sanitize.text.function=function(x){x})




```




# Power Tables For Reviewer Response

## Oversaturated Model
```{r}
oversat_run <- "run_20250804"
oversat_inference_output <- readRDS(file=paste0(analysis_path, oversat_run))
```


```{r}
n_list_oversat <- c(661, 106, 42, 27)
delta_list_oversat <- c(0.2, 0.5, 0.8, 1)
oversat_label_df <- data.frame(n=n_list_oversat, delta=delta_list_oversat)
oversat_table_sets <- 
  data.frame(fit=c("fit_1", "fit_2", "alt_fit_1", "alt_fit_2"),
             suff=c(".long", ".long.ind", ".static", ".oversat"))

oversat_tables <- NULL
oversat_tables_fits <- NULL
for (setting in rownames(oversat_table_sets)) {
  fit <- oversat_table_sets[setting, "fit"]
  oversat_tables_fits[[setting]] <- NULL
  for (row in rownames(oversat_label_df)) {
    delta <- oversat_label_df[row, "delta"]
    n <- oversat_label_df[row, "n"]
    description <- paste0("$\\delta=", delta, "$ ($n=", n, "$)")
    sim_label <- paste0("sim_ASIC-Eff-Size-yTot-n:2-ES:", format(delta, nsmall=1))
    if (substr(fit, 1, 3)=="fit") {
      oversat_tables_fits[[setting]][[description]] <- 
        list(fit_data=oversat_inference_output[[sim_label]][[fit]][["EOS"]],
             filter_statement=comp_filter)
    } else {
      oversat_tables_fits[[setting]][[description]] <- 
        list(fit_data=oversat_inference_output[[sim_label]][[fit]],
             filter_statement=comp_filter)
    }
  }
  temp_table <- Summarize_Multiple_Fits(fit_list=oversat_tables_fits[[setting]])
  oversat_tables[[setting]] <- Round_and_Format_DF(df=temp_table, n_digits=2)
}

oversat_table <- data.frame()
#cols_to_show_oversat <- c("Relative_Bias", "RMSE", "Coverage", "Power")
cols_to_show_oversat <- c("RMSE", "Coverage", "Power")

for (es in unique(oversat_tables[[1]]$Description)) {
  new_row <- data.frame("Effect Size (n)"=es)
  tab_data <- NULL
  for (setting in rownames(oversat_table_sets)) {
    tab_data[[setting]] <- 
      oversat_tables[[setting]][oversat_tables[[setting]]$Description==es, ]
  }
  for (col in cols_to_show_oversat) {for (setting in rownames(oversat_table_sets)) {
    suff <- oversat_table_sets[setting, "suff"]
    new_row[[paste0(col, suff)]] <- tab_data[[setting]][[col]]
  }}
  oversat_table <- rbind(oversat_table, new_row)
}


```



```{r Print Oversat Tables}


# Oversaturated vs Static
oversat_table_1 <- 
  oversat_table[ , c(1, grep("\\.(oversat|static)$", names(oversat_table)))]
oversat_table_1 <- oversat_table_1[, c(1,3,2,5,4,7,6)]
oversat_table_1_cap <- 
  Create_Caption(table=oversat_table,
                 caption="Static vs Oversaturated Longitudinal Efficiency Comparison",
                 label="tab:eff_comp:oversat")
print(xtable(x=oversat_table_1), include.rownames=FALSE, 
      add.to.row=oversat_table_1_cap, sanitize.text.function=function(x){x})


# Old Table - Longitudinal (Independent) vs Static
oversat_table_2 <- 
  oversat_table[ , c(1, grep("\\.(long.ind|static)$", names(oversat_table)))]
oversat_table_2_cap <- 
  Create_Caption(table=oversat_table,
                 caption="Static vs Longitudinal (Independent) Efficiency Comparison",
                 label="tab:eff_comp:long_ind")
print(xtable(x=oversat_table_2), include.rownames=FALSE, 
      add.to.row=oversat_table_2_cap, sanitize.text.function=function(x){x})

# Longitudinal vs Longitudinal (Independent)
oversat_table_2a <- 
  oversat_table[ , c(1, grep("\\.(long|long.ind)$", names(oversat_table)))]
oversat_table_2a_cap <- 
  Create_Caption(table=oversat_table,
                 caption="Longitudinal vs Longitudinal (Independent) Efficiency Comparison",
                 label="tab:eff_comp:long_ind")
print(xtable(x=oversat_table_2a), include.rownames=FALSE, 
      add.to.row=oversat_table_2a_cap, sanitize.text.function=function(x){x})

# Unified
oversat_table_3 <- 
  oversat_table[ , c(1, grep("\\.(long|oversat|long.ind)$", names(oversat_table)))]
oversat_table_3 <- oversat_table_3[, c(1,2,4,3,5,7,6,8,10,9)]
oversat_table_3_cap <- 
  Create_Caption(table=oversat_table,
                 caption="Unified Efficiency Comparisons",
                 label="tab:eff_comp:unified")
print(xtable(x=oversat_table_3), include.rownames=FALSE, 
      add.to.row=oversat_table_3_cap, sanitize.text.function=function(x){x})



# Unified Table for Reviewer
oversat_table_3 <- 
  oversat_table[ , c(1, grep("\\.(long|oversat|static)$", names(oversat_table)))]
oversat_table_3 <- oversat_table_3[, c(1,2,4,3,5,7,6,8,10,9)]
oversat_table_3_cap <- 
  Create_Caption(table=oversat_table,
                 caption="Analysis of Oversaturated Model",
                 label="tab:eff_comp:unified")
print(xtable(x=oversat_table_3), include.rownames=FALSE, 
      add.to.row=oversat_table_3_cap, sanitize.text.function=function(x){x})
```






# Show Monte Carlo Confidence Intervals
```{r Print MC CIs}
print("Estimator Performance by Sample Size")
print(base_table)

print("Longitudinal Model, High Correlation")
print(es_table_1)
print("Static Model, High Correlation")
print(es_table_2)
print("Longitudinal Model, Low Correlation")
print(es_lc_table_1)
print("Static Model, Low Correlation")
print(es_lc_table_2)

print("Working Variance Misspecification")
print(wvm_tables)

print("Seven Time Points: Modeling All Time Points")
print(multi_t7_table_all)
print("Seven Time Points: Modeling t_0, t^*, t_T")
print(multi_t7_table_sat)

print("Five Time Points: Modeling All Time Points")
print(multi_t5_table_all)
print("Five Time Points: Modeling t_0, t^*, t_T")
print(multi_t5_table_sat)


print("Oversaturated Model Comparisons")
print("Long.")
print(oversat_tables[[1]])
print("Long. (Ind.)")
print(oversat_tables[[2]])
print("Static")
print(oversat_tables[[3]])
print("Long. (Oversat)")
print(oversat_tables[[4]])
```







# Get Simulation Parameter Bounds
```{r Read In Driver}
# Define alternate fit settings
alt_fit_settings_types_sheets <- list(c("static", "alt_fit_settings_static"))


# Read in Driver File
full_driver <- Read_Driver_File(path=paste0(notes_path, "Driver_Three_Level_Simulations.xlsx"), 
                                driver_sheet="main", 
                                cp_sheet="cond_param_settings",
                                var_parm_pre_r_sheet="var_parm_settings_pre_r",
                                var_parm_post_r_sheet="var_parm_settings_post_r",
                                fit_settings_sheet="fit_settings",
                                alt_fit_settings_types_sheets=alt_fit_settings_types_sheets)

settings_in_tables <- 
  c("ASIC-Primary-20", "ASIC-Primary-30", "ASIC-Primary-40", "ASIC-Primary-50", 
  "ASIC-Primary-75", "ASIC-Primary-100", "ASIC-Primary-500", "ASIC-Eff-Size-yTot-n:2-ES:0.2", 
  "ASIC-Eff-Size-yTot-n:2-ES:0.5", "ASIC-Eff-Size-yTot-n:2-ES:0.8", "ASIC-Eff-Size-yTot-n:2-ES:1.0", 
  "ASIC-Eff-Size-y-n:2-ES:0.2", "ASIC-Eff-Size-y-n:2-ES:0.5", "ASIC-Eff-Size-y-n:2-ES:0.8", 
  "ASIC-Eff-Size-y-n:2-ES:1.0", "ASIC-WVM-ytot-thet-dAR-odUn-n:20", 
  "ASIC-WVM-ytot-thet-dAR-odUn-n:30", "ASIC-WVM-ytot-thet-dAR-odUn-n:40", 
  "ASIC-WVM-ytot-thet-dAR-odUn-n:50", "ASIC-WVM-ytot-thet-dAR-odUn-n:75", 
  "ASIC-WVM-ytot-thet-dAR-odUn-n:100", "ASIC-WVM-ytot-thet-dAR-odUn-n:150", 
  "ASIC-WVM-ytot-thom-dIn-odIn-n:20", "ASIC-WVM-ytot-thom-dIn-odIn-n:30", 
  "ASIC-WVM-ytot-thom-dIn-odIn-n:40", "ASIC-WVM-ytot-thom-dIn-odIn-n:50", 
  "ASIC-WVM-ytot-thom-dIn-odIn-n:75", "ASIC-WVM-ytot-thom-dIn-odIn-n:100", 
  "ASIC-WVM-ytot-thom-dIn-odIn-n:150")
```


```{r Grab Simulation Bounds}
sims_used <- 
  full_driver[["driver"]][full_driver[["driver"]]$sim_label %in% settings_in_tables, ]

n_clusters_used <- unique(sims_used$n_clusters)
cluster_sizes_used <- c()
for (row in rownames(sims_used)) {
  cluster_sizes_used <- 
    c(cluster_sizes_used, eval(parse(text=sims_used[row, "cluster_sizes"])))
}
cluster_sizes_used <- unique(cluster_sizes_used)
eff_sizes_used <- data.frame()
cp_setting_used <- unique(sims_used$cond_parm_setting)
cp_settings_df <- full_driver[["cp_settings"]]
post_r_var_df <- full_driver[["var_parms_post_r"]]
for (lab in cp_setting_used) {
  cp_settings <- cp_settings_df[cp_settings_df$cond_parm_setting==lab, ]
  # Drop conditional specs
  cp_settings <- cp_settings[!is.na(cp_settings$dtr), ]
  
  true_diff <- cp_settings[cp_settings$dtr=="d_1_1", "mean_2"] - 
    cp_settings[cp_settings$dtr=="d_m1_m1", "mean_2"]
  
  var_setting_1 <- cp_settings[cp_settings$dtr=="d_1_1", "post_r_var_str"]
  var_setting_2 <- cp_settings[cp_settings$dtr=="d_m1_m1", "post_r_var_str"]
  var_1 <- 
    post_r_var_df[post_r_var_df$cond_param_setting_post_r==var_setting_1, "sigma2_2"]
  var_2 <- 
    post_r_var_df[post_r_var_df$cond_param_setting_post_r==var_setting_1, "sigma2_2"]
  sigma_approx <- sqrt(mean(var_1, var_2))
  eff_sizes_used <- rbind(eff_sizes_used, 
                          data.frame(cond_parm_setting=lab,
                                     eff_size=true_diff/sigma_approx))
}
```


```{r Print Parameter Bounds}
message("Sample Size Range - N Clusters: (", 
        min(n_clusters_used), ", ", max(n_clusters_used), "); Cluster Size: (",
        min(cluster_sizes_used), ", ", max(cluster_sizes_used), ")")
message("Effect Size Range: (", min(eff_sizes_used$eff_size), ", ",
        max(eff_sizes_used$eff_size), ")")
```


